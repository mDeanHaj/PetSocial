<%- include("partials/header.ejs") %>

<div class="content-wrap">
    <!-- Blog Header -->
    <h1 class="page-title">Community Blog</h1>

    <!-- New Post Button (only for logged-in users) -->
    <% if (userId) { %>
        <div class="new-post-button-container">
            <button onclick="window.location.href='/blog/new'" class="new-post-button">+ Share a New Post</button>
        </div>
    <% } else { %>
        <p class="login-prompt">
            Please <a href="/login">log in</a> to add a new post.
        </p>
    <% } %>

    <div class="blog-container">
        <!-- Blog Posts Section -->
        <div class="blog-posts">
            <% if (posts.length > 0) { %>
                <% posts.forEach(post => { %>
                    <div class="post" data-id="<%= post.post_id %>">
                        <header class="post-header">
                            <h2 class="post-title"><%= post.title %></h2>
                            <p class="post-meta">By <strong><%= post.username %></strong> on <%= new Date(post.created_at).toLocaleDateString() %></p>
                        </header>
                        <p class="post-content"><%= post.content %></p>

                        <!-- Actions Section -->
                        <div class="post-actions">
                            <% if (post.flagged) { %>
                                <button class="action-button unflag-post" onclick="toggleFlag('<%= post.post_id %>', false)">Unflag</button>
                            <% } else { %>
                                <button class="action-button flag-post" onclick="toggleFlag('<%= post.post_id %>', true)">Flag</button>
                            <% } %>

                            <% if (post.user_id === userId) { %>
                                <button class="action-button edit-post" onclick="showEditForm('<%= post.post_id %>')">Edit</button>
                                <button class="action-button delete-post" onclick="deletePost('<%= post.post_id %>')">Delete</button>
                            <% } %>
                        </div>


                        <!-- Edit Form -->
                        <% if (post.user_id === userId) { %>
                            <div id="edit-form-<%= post.post_id %>" class="edit-post-form hidden">
                                <h3>Edit Post</h3>
                                <form onsubmit="submitEdit('<%= post.post_id %>'); return false;">
                                    <label for="edit-title-<%= post.post_id %>">Title:</label>
                                    <input type="text" id="edit-title-<%= post.post_id %>" value="<%= post.title %>" required>

                                    <label for="edit-content-<%= post.post_id %>">Content:</label>
                                    <textarea id="edit-content-<%= post.post_id %>" rows="5" required><%= post.content %></textarea>

                                    <button type="submit" class="action-button save-button">Save</button>
                                    <button type="button" class="action-button cancel-button" onclick="hideEditForm('<%= post.post_id %>')">Cancel</button>
                                </form>
                            </div>
                        <% } %>
                    </div>
                <% }) %>
            <% } else { %>
                <p class="no-posts-message">No posts yet. Be the first to share!</p>
            <% } %>
        </div>
    </div>
</div>

<%- include("partials/footer.ejs") %>
<script src="/js/script.js"></script>
